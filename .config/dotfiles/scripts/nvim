#!/usr/bin/env bash
# Author: Alalilacias
# Description: Installs the latest Neovim using system-specific unstable repositories
# Syntax: source "$HOME/.dotfiles/.config/dotfiles/scripts/nvim"
# Version: 0.3

main() {
  set -euo pipefail

  if command -v apt &>/dev/null; then
    debian_installation
  elif command -v dnf &>/dev/null; then
    fedora_installation
  elif command -v pacman &>/dev/null; then
    arch_installation
  else
    log_error "Unsupported system: no known package manager found"
    return 1
  fi
}

debian_installation() {
  if ! command -v add-apt-repository &>/dev/null; then
    log_error "software-properties-common not found, unable to install neovim."
    return 1
  fi

  log_debug "Adding Neovim unstable PPA"
  sudo add-apt-repository -y ppa:neovim-ppa/unstable
  sudo apt update
  sudo apt install -y neovim
}

fedora_installation() {
  log_debug "Installing dnf-plugins-core if not present"
  sudo dnf install -y dnf-plugins-core

  log_debug "Enabling Neovim nightly COPR repo"
  sudo dnf copr enable -y agriffis/neovim-nightly
  sudo dnf install -y neovim
}

arch_installation() {
  if command -v paru &>/dev/null || command -v yay &>/dev/null; then
    AUR_HELPER=$(command -v paru || command -v yay)
    log_debug "Installing neovim-nightly-bin via $AUR_HELPER"
    "$AUR_HELPER" -S --noconfirm neovim-nightly-bin
  else
    log_warn "No AUR helper (paru or yay) found. Falling back to stable Neovim."
    sudo pacman -S --noconfirm neovim
  fi
}

main
